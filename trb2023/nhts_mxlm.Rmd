---
title: Explore Regional Variation in the Effects of Built Environment on Driving with High Resolution U.S. Nation-wide Data
author:
  - name: Liming Wang
    email: lmwang@pdx.edu
    affiliation: Portland State University
    address: Toulan School of Urban Studies and Planning
    address2: Portland, OR, 97222
authorheader: Wang
abstract: |
  There have now been numerous studies on the relationship between travel behavior and built environment over the last a few decades. Prior studies have mostly focused on producing point estimates of model coefficients and ended up with a wide range of estimates for the built environment elasticity of travel behavior, including household VMT. With few exceptions, previous studies use data from a single region or a small number of regions, and thus are not able to sufficiently investigate the regional variation in built environment elasticity. A few  papers have addressed the heterogeneity of elasticity among different population groups and neighborhood types [for example, @salon_heterogeneity_2015; @voulgaris_synergistic_2016], but so far have paid little attention to regional variation of elasticity. In this paper, I use the 2009 U.S. National Household Travel Survey and high resolution built environment measures in the Smart Location Database to investigate the regional variation in the effect of built environment.
keywords: Built Environment, VMT, Regional Variation of Elasticity
bibliography: trb2023.bib
csl: transportation-research-record.csl
wordcount:
  words: "`r wordcountaddin::word_count(whereami::thisfile())`"
  tables: 9
  WordsPerTable: 250
output:
  bookdown::pdf_book:
    base_format: rticles::trb_article
header-includes:
    - \usepackage{booktabs}
    - \usepackage{longtable}
    - \usepackage{dcolumn}
    - \usepackage{rotating}
    - \usepackage{subfig}
  
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "../")
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
options(scipen=100)
options(digits=3)

if (!require("pacman")) {install.packages("pacman"); library(pacman)}
p_load_gh("jrnold/resamplr")
p_load(dplyr, purrr, mlogit, gmnl, lcmm, lme4, splines, stringr, 
       stargazer, MASS, pscl, modelr, AER, texreg, tableone,
       moments, knitr, multidplyr)

output_format <- knitr::opts_knit$get("rmarkdown.pandoc.to") #html/latex
if (is.null(output_format)) {
  output_format <- "text"
  # properreg <- case_when(
  #   output_format=="text" ~ screenreg,
  #   output_format=="html" ~ htmlreg,
  #   output_format=="pdf"  ~ texreg,
  #   TRUE                  ~ screenreg)
}
br <- ifelse(output_format=="html", "<br>", "\n")

```


# Introduction

There have now been numerous studies on the relationship between travel behavior and built environment over the last a few decades. Prior studies have predominately focused on producing point estimates of model coefficients, but they ended up with a wide range of estimates for  built environment's effects on travel behavior, including household VMT. While more recent studies started to present the heterogeneity in this relationship, few have investigated the regional variation of the relationship.

One of the reasons for this omission is that, with very few exceptions, previous studies use data from a single region or a small number of regions, and thus are not able to sufficiently investigate the regional variation in the effects of built environment, because, until recently, it requires major effort to harmonize data, for example, travel surveys, from different regions (see, for example @ewing_varying_2015). Even then, questions remain whether the measures from in data pieced together from multiple regions are comparable as they were collected at different times by different agencies with different survey instruments.

In this paper, I explore the regional variation in the effects of built environment with a unique high resolution U.S. nationwide dataset that was created by joining the 2009 U.S. National Household Travel Survey and the high resolution built environment measures from the EPA Smart Location Database. I apply fixed effects and hierarchical mixed effects models and compare the results to investigate the regional variation in the effects of built environment. I find that there is indeed substantial regional variation in the effects, so much so that there is almost no fixed effect of most built environment measures after considering the random effects. I conclude the paper with a discussion of the implications and limitations of this research.

# Literature Review

Over the last a few decades, there has been extensive research on the elasticity of travel to built environment. Ewing and Cervero [-@ewing_travel_2010-1] identify and synthesize more than a hundred papers on the topic between 1990s and 2010. Aston et al. [-@aston2021] collected 187 studies on the topic of built environment and transit use.

A primary focus of this research is the direction and magnitude of the elasticity. For example, the elasticity of VMT to density (various measures) in the research reviewed by Ewing and Cervero [-@ewing_travel_2010-1] ranges from 0.03 to -1.05 (Table A-1, page 282), with a synthesized elasticity of -0.04. Based the low built environment elasticity of driving, Stevens [-@stevens_does_2017] argues that densification has limited potential as a policy tool to reduce VMT. Research of Aston et al. [-@aston2021] shows that research design has a substantial impact on the size of estimated effect.

Most prior studies uses various measures of built environment with data from a single region or a few regions.  A few studies use nationwide data but with coarse measures of built environment. For example, Cervero and Murakami [-@cervero_effects_2010] use the 2001 US National Household Travel Survey to investigate the relationship between built environments on vehicle miles traveled using the UZA (Urbanized Area) as the unit of analysis and find population and job density at the UZA level is negatively associated with the average VMT per capita of a UZA. A few more recent papers use the 2009 US National Household Travel Survey to examine the heterogeneity of travel behavior across different neighborhood types and population groups [@salon_heterogeneity_2015; @voulgaris_synergistic_2016], but they ignore regional variations and/or heterogeneity. Bento et al [@bento_effects_2005-1] use 1990 NPTS to estimate pooled models of travel outcomes including driving and their models do not allow regional variation of coefficients.

Ewing et al [-@ewing_varying_2015] argue that hierarchical multi-level models would be a more appropriate model structure when the data include multiple regions, as the households from the same region likely shared many of the regional characteristics. They study the varying influences of the built environment on household travel with pooled data from 15 regions in the US. Even though they apply hierarchical linear modelling (HLM), they do not investigate the random effects of built environment due the small number of regions in their data. Ewing et al [-@ewing_traffic_2011] uses hierarchical models to study travel outcomes including VMT using data from 6 regions in the US and their models only consider random intercept (no random slope considered).

Other research compares models estimated with data from a few different places. Zhang [@zhang_role_2004] compares mode choice models estimated with data from Boston and Hong Kong and finds that elasticity of mode choice probabilities are largely consistent between Boston and Hong Kong even though there are variations in the elasticity for some of the modes. He does not look into driving distance (VMT).

To my knowledge, there is little research that systematically investigates the regional variations in built environment elasticity and this paper aims to start to fill that gap with a high resolution dataset including all large UZAs in the U.S.

<!-- Given previous research mostly focusing on one or a few regions, they are not able to sufficiently test the hypotheses of variation of elasticity across regions.  -->



<!-- In this research, I systematically investigate the variation of elasticity between VMT and built environment. With multi-level hierarchical regression models of a nation, I look for explanations of the variation in elasticity of VMT to built environment. -->

<!-- - focus on UZAs with region level transit service (transit revenue miles per capita; transit revenue miles/sq miles) -->
<!-- - freeway lane miles -->

<!-- Salon [-@salon_heterogeneity_2015] uses a similar dataset as ours and investigate the heterogeneity of elasticity across different neighborhood types, while  -->



<!-- In this paper, I focus on investigating two sources of variations in built environment elasticity: 1.) choice of model structures and 2.) regional variation.  -->


```{r functions}
Eyx <- function(ybars) {
  stopifnot(any(ybars$dx == 1.0))
  y0 <- ybars %>% 
    filter(dx == 1.0) %>% 
    dplyr::select(model_num, y0=y_hat)
  
  ybars %>%
    filter(dx != 1.0) %>% 
    dplyr::select(model_num, dx, y_hat) %>% 
    left_join(y0, by="model_num") %>% 
    mutate(pdy=map2(y_hat, y0, ~(.x - .y)/.y), 
           pdx=dx - 1,
           E = map2(pdx, pdy, ~.y/.x),
           E_bar=map_dbl(E, ~mean(.x[is.finite(.x)], na.rm=T)))
}

aggregate_Eyx <- function(ybars) {
  ## second approach
  ## first aggregated dy/y before divided by (dx/x)
  stopifnot(any(ybars$dx == 1.0))
  y0 <- ybars %>% 
    filter(dx == 1.0) %>% 
    dplyr::select(model_num, y0=yhat_bar)

  ybars %>% 
    filter(dx != 1.0) %>% 
    dplyr::select(model_num, dx, yhat_bar) %>% 
    left_join(y0, by="model_num") %>% 
    mutate(pdy=(yhat_bar - y0)/y0, 
           pdx=dx - 1, E_bar=pdy/pdx)
}

prep_tableone <- function(tableone_mx) {
  dimnames(tableone_mx) <- dimnames(tableone_mx) %>% 
    purrr::map(~stringr::str_replace_all(., " ", "&nbsp;"))
  tableone_mx[] <- stringr::str_replace_all(tableone_mx, "\\s", "&nbsp;")
  tableone_mx
}

clip_range <- function(x, y) {
  lower <- min(y, na.rm=T)
  upper <- max(y, na.rm=T)
  clip_bound(x, lower=lower, upper=upper)
}


clip_bound <- function(x, lower=0, upper=Inf) {
  dplyr::case_when(x<lower~lower,
                   x>upper~upper,
                   TRUE~x
                   )
}

add_pseudo_r2 <- function(df) {
  # tobit model is peculiar in update() call
  df %>% 
    # constant only model
    mutate(
      r2_mclass=map_chr(model, ~class(.)[1]),
      r2_model0=case_when(r2_mclass == "tobit"   ~ map2(model, train, ~update(.x, .~1,      .y)),
                          #r2_mclass == "lmerMod" ~ map2(model, train, ~update(.x, .~1 + (1|UACE), data=.y)),
                          #r2_mclass == "lm"      ~ map2(model, train, ~update(.x, .~1, data=.y)),
                          TRUE                   ~ list(NA)),
      #r2_ll0 = map_dbl(r2_model0, logLik),
      #r2_ll1 = map_dbl(model, logLik),
      #pseudo.r2 = 1 - r2_ll1/r2_ll0
      0
      ) #%>% 
    #dplyr::select(-starts_with("r2_"))
}    

add_pseudo_r2b <- function(df) {
  # tobit model is peculiar in update() call
  df %>% 
    mutate(r2_mclass=map_chr(model, ~class(.)[1])) %>% 
    filter(r2_mclass=="tobit") %>% 
    mutate(r2_model0=map2(model, train, ~update(.x, .~1, .y))) %>% 
    bind_rows(
      df %>% 
        mutate(r2_mclass=map_chr(model, ~class(.)[1])) %>% 
        filter(r2_mclass!="tobit") %>% 
        mutate(r2_model0=map2(model, train, ~update(.x, .~1, data=.y)))
    ) %>% 
    mutate(
      r2_ll0 = map_dbl(r2_model0, logLik),
      r2_ll1 = map_dbl(model, logLik),
      pseudo.r2 = map2_dbl(r2_ll0, r2_ll1, function(ll0, ll1) 1 - ll1/ll0)) %>% 
    dplyr::select(-starts_with("r2_"))
}

est_model_with <- function(data, fmla_df) {
  data %>% 
  tidyr::crossing(fmla_df) %>% 
  mutate(model = map2(train, fmla, est_model),
         #ba_y_train = map(train, "DVMT"),
         #ba_preds_train = map(model, fitted),
         #ba_yhat_train = map2(ba_preds_train, post_func, `.y(.x)`),
         #ba_yhat_train = map2(ba_yhat_train, ba_y_train, ~clip_range(.x, .y)),
         #bias_adj_val = map2_dbl(ba_y_train, ba_yhat_train, ~mean(.x, na.rm=TRUE)/mean(.y, na.rm=TRUE)),
         #bias_adj_val = ifelse(bias_adj, bias_adj_val, 1.0),
         preds = map2(model, test, predict, type="response"),
         yhat = map2(preds, post_func, `.y(.x)`),
         #yhat = map2(yhat, bias_adj_val, `*`),
         #y = map(test, resample_get, col_name="DVMT"),
         y = map(test, "DVMT"),
         rmse = map2_dbl(yhat, y, calc_rmse),
         nrmse = map2_dbl(yhat, y, calc_nrmse),
         AIC=map_dbl(model, AIC),
         BIC=map_dbl(model, BIC)
         ) %>%
  #add_pseudo_r2() %>% 
  dplyr::select(-c(test, train), starts_with("ba_"))
}
# `$.resample` <- function(resample_obj, col_name) {
#   print("calling $.resample")
#   data <- resample_obj[["data"]]
#   idx <- resample_obj[["idx"]]
#   if (col_name=="data") {
#     data
#   } else if (col_name=="idx") {
#     idx
#   } else
#     return(data[idx, ][[col_name]])
# }
# 
# `[.resample` <- function(resample_obj, col_name) {
#   print("calling [.resample")
#    resample_obj$data[resample_obj$idx, col_name]
# }
#  
# `[[.resample` <- function(resample_obj, col_name) {
#   print("calling [[.resample")
#    resample_obj$data[resample_obj$idx, col_name]
#}
```


```{r source}
source('code/functions.R')
#source('code/load_data.R')
source('code/comp_dependencies.R')
source('code/rename_variables.R')
source('code/included_sample.R')
source('code/partition_data.R')
source('code/est_models.R')
source('code/filter_hh_df.R')

start_from_raw_data <- FALSE

data_to_load <- c(hh_df="output/intermediate/hh_df.rds",
                  sld_df="output/intermediate/sld_df.rds",
                  ua_df="output/intermediate/ua_df.rds")

if (start_from_raw_data) {
  source("code/load_data2.R")
  imap(data_to_load, ~saveRDS(get(.y), file=.x))
} else if (map_lgl(names(data_to_load),  exists) %>% all) { # if all data exit in memory
  # do nothing
} else if (map_lgl(data_to_load, file.exists) %>% all) { # if all data exit as cached files
  iwalk(data_to_load, function(x, y) assign(y, readRDS(file=x), envir = .GlobalEnv))
} else {
  source("code/load_data2.R")
  imap(data_to_load, ~saveRDS(get(.y), file=.x))
}

hh_df1 <- compute_dependencies(hh_df) %>% 
  rename_variables() %>% 
  label_sample()

## escape dollar sign ($) in the HHFAMINC20k variable for latex/pdf
hh_df1 <- hh_df1 %>% 
  mutate(HHFAMINC20k=str_replace(HHFAMINC20k, fixed("$"), "\\$"))
```

<!-- VMT vs VKT (to be consistent with Ewing & Cervero?) -->

<!-- - Why choose DVMT over Annual VMT (BESTMILE)? -->
<!--     * consistent with previous research -->
<!--     * BESTMILE contains imputed data -->

<!-- my work is similar to [@ewing_varying_2015]'s in scope, but I use a nationwide dataset instead of pooling datasets from multiple regions. In addition to understanding the variation across regions, I also investigate the variations arising from researchers' model structure choice. -->

# Data

I utilize a unique data set created by joining two US nation-wide data sources that provides information including travel behavior, household social-economic characteristics, and high resolution built environment measures.

### National Household Travel Survey

The 2009 National Household Travel Survey (NHTS) [@nhts_2009] is a nation-wide travel survey conducted by the Federal Highway Administration of US Department of Transportation that surveyed more than 150,000 households between 2008 and 2009. Travel diaries over 24 hours on the day of the survey, as well as survey participants' socio-demographic characteristics, are captured in the survey. For this study, I focus on total household vehicle miles traveled (VMT). Figure \@ref(fig:vmt-hist) shows a histogram of survey day household VMT. I applied the household weights in the NHTS dataset in descriptive statistics and all model estimation.

```{r vmt-hist, fig.cap="Histogram of household VMT and Mean and 95% CI of household VMT by day of travel"}
#descriptives
#hh_df %>% group_by(UZA) %>% 
#  tally

p1 <- ggplot(hh_df, aes(DVMT)) + geom_histogram() +
  labs(x="VMT", y="# households")

#p1 
hh_df_travday <- hh_df %>% 
  mutate(`Day of Travel`=dplyr::recode(TRAVDAY,
                                "01"="Sun", "02"="Mon", 
                                "03"="Tues", "04"="Wed", 
                                "05"="Thur", "06"="Fri", 
                                "07"="Sat"),
         `Day of Travel`=factor(`Day of Travel`, levels=c("Sun", "Mon", "Tues", "Wed", 
                                                          "Thur", "Fri", "Sat"))) %>% 
  group_by(`Day of Travel`) %>% 
  summarise(mean=mean(DVMT, na.rm=TRUE),
            sd=sd(DVMT, na.rm=TRUE),
            n=n(),
            moe=1.96*sd/sqrt(n)
            )
p2 <- ggplot(hh_df_travday, aes(`Day of Travel`, mean)) + 
  geom_bar(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-moe, ymax=mean+moe), width=.2,
                 position=position_dodge(.9)) +
  labs(y="VMT (Mean and 95% Confidence Interval") +
  scale_fill_brewer(palette="Paired") + theme_minimal()
#p2
gridExtra::grid.arrange(p1, p2, nrow=1)

# VIF correlation

# factor analysis (fa) or not fa
```

I was able to access the confidential residence Census Block Group (2010 geography) for all households in the 2009 NHTS. I used the residence block group to join the household characteristics and travel outcomes in NHTS with the Smart Location Database to create a unique nationwide dataset with rich social-economic characteristics and built environment information.

### Smart Location Database

The Smart Location Database (SLD) is a US nationwide database with extensive built environment variables organized around the 5D categorization: D1 - Density, D2 - Diversity, D3 - Design, D4 - Distance to transit and D5 - Destination accessibility. It includes more than 90 built environment measures such as population density, diversity of land use, neighborhood design, destination accessibility, transit service, employment, and demographics. Most measures are available for every Census block group covering the whole United States [@ramsey_smart_2014] except for the D4 transit variables, most of which are missing for a substantial portion of the dataset. For this reason, I am limited in my choice of D4 variables in my model specifications.

Variables within the same 5D category in the SLD are generally highly correlated. For example, D1B (block group level population density) has a Pearson's correlation of `r sld_df %>% dplyr::select(D1B, D1A) %>% cor(use="complete.obs")` with D1A (block group level housing density) and `r sld_df %>% dplyr::select(D1B, D1D) %>% cor(use="complete.obs")` with D1D (block group level activity density). With a few exceptions involving the D3 Design and D4 Transit variables (between D4d - Aggregate frequency of transit service per square mile and D3a - Total road network density, D3aao - Network density in terms of facility miles, D3bao - Intersection density), the correlations between variables across 5D categories are low to moderate (< 0.4). Throughout the paper I provide brief descriptions of built environment variables used in the paper, all of which are at the block group level unless noted otherwise. A complete definition of them can be found in the Smart Location Database documentation [@ramsey_smart_2014].


```{r sld-cor}
# fig.cap="Correlation among Primary D5 Built environment Measures in Smart Location Database"
#librarian::shelf(corrr)
v <- sld_df %>% dplyr::select(D1A, D1B, D1C, D1D, 
                         D2A_EPHHM, D2A_JPHH, D2A_WRKEMP, D2C_TRIPEQ, D2C_TRPMX1, 
                             D2C_TRPMX2, D2C_WREMIX, D2R_JOBPOP, D2R_WRKEMP,
                         D3a, D3aao, D3amm, D3apo, D3b, D3bao, D3bmm3, D3bmm4, D3bpo3, D3bpo4,
                         D4a, D4b025, D4b050, D4c, D4d, D5ar) %>% 
  cor(use="complete.obs")

```

Some previous research has utilized the Smart Location Database. For example, Voulgaris et al[@voulgaris_synergistic_2016] apply factor analysis to reduce the dimensionality of the many variables and cluster analysis to classify locations to a small number of types - loosely labeled as neighborhood types. The approach has the advantage of utilizing more information in the data, but it makes the interpretation, comparision, and application of the research results more difficult. For this reason, I use the original variables in the database. From each of the 5D categories, I choose at least one variable that have the best improvement to model fit while avoiding including variables that are highly correlated.

I exclude a portion of the joined dataset from this study. Households in NHTS were surveyed for a 24-hour period either on weekdays and in weekends, but since households surveyed during weekends have substantial lower VMT (Figure \@ref(fig:vmt-hist)), I exclude those households in my sample (n=`r nrow(hh_df %>% filter(TRAVDAY %in% c("01", "07")))`. It is unknown whether households were surveyed on non-weekend holidays as the survey date is not provided. Since I focus on total VMT of all household members, I also exclude households with incomplete member information (FLAG100=02, n=`r nrow(hh_df %>% filter(FLAG100=="02"))`). Finally, to use the same sample throughout all models for comparability, I limit my sample to households living in urbanized areas with at least 100 valid household observations because my hierarchical mixed effect models use Urbanized Area (UZA) as a level in the hierarchical models (n=`r nrow(hh_df %>% group_by(UA_NAME) %>% mutate(nhhs=n()) %>% filter(is.na(UA_NAME) | nhhs < 100))`. Because there is overlap among these three criteria, I end up with `r (n1 <- hh_df1 %>% filter(Sample=="Included") %>% nrow())` households out of `r nrow(hh_df1)` in this study. Table \@ref(tab:descr) shows the descriptive statistics of the variables for observations in (Included) and out of (Excluded) my sample. Finally, `r n1 - hh_df1 %>% filter(Sample=="Included") %>% select_variables() %>% drop_na() %>% nrow()` of these `r n1` household observations contain missing values in at least one of the variables and are dropped in the model estimation process.

```{r descriptives, results="asis"}
# limit analysis to UZAs w/ lane-miles & transit information

#hh_df <- filter_hh_df(hh_df)

#hh_df <- hh_df %>% 
#  mutate(HPMS=ifelse(is.na(FwyLaneMiP1k), "No", "Yes"),
#         NTD =ifelse(is.na(UZAVehOp),   "No", "Yes"),
#         urban=case_when(
#                        LSADC==75 ~ "Urbanized Area",
#                        LSADC==76 ~ "Urban Cluster",
#                        TRUE     ~ "Non-Urban"))

# desc_vars <- c("DVMT", "TRAVDAY", "FLAG100", "HPMS", "NTD")
# cat_vars  <-  hh_df %>% 
#   dplyr::select_(.dots=desc_vars) %>%
#   dplyr::select_if(~!is.numeric(.x)) %>% 
#   names()
# CreateTableOne(vars=desc_vars, strata=c("urban"), data=hh_df, factorVars = cat_vars)

#hh_df1

# hh_df <- hh_df %>% 
#   group_by(UACE) %>% 
#   mutate(nhhs=n()) %>% 
#   ungroup() %>% 
#   filter(nhhs >= 30)

desc_vars <- c("Household VMT"="DVMT", "Household Size"="HhSize", "Life Cycle"="LifeCycle", 
               "Workers"="Workers", 
               "Family Income"="HHFAMINC20k", 
               "Poverty Status"="poverty", "Zero Vehicle"="ZeroVeh",
               "Vehicles per Driver"="VehPerDriver",
               "D1B\\: Population density"="D1B", "D2A_WRKEMP\\: Household workers per Job"="D2A_WRKEMP",
               "D3a\\: Total road network density"="D3a", 
               "D4b050\\: Proportion of jobs within 0\\.5 mile of transit stop"="D4b050", 
               "D5ar1k\\: Jobs within 45 minutes auto travel time\\/1000"="D5ar1k")

desc_hh_df <- hh_df1 %>% 
  dplyr::select(!!!desc_vars, Sample) %>% 
  mutate(`Poverty Status`=factor(`Poverty Status`),
         `Life Cycle`=factor(`Life Cycle`),
         `Family Income`=factor(`Family Income`),
         `Zero Vehicle`=factor(`Zero Vehicle`)
         )
ncol_1 <- ncol(desc_hh_df) -1 # exclude column `Sample`
furniture::table1(desc_hh_df, 
                  c(1:ncol_1), 
                  splitby = "Sample",
                  format_number = TRUE,
                  caption="Descriptive Statistics of Main Variables",
                  label="tab:descr",
                  float="!h",
                  output="latex2")
```

```{r filter}
hh_df2 <- hh_df1 %>% 
  filter(Sample=="Included")
```

The households in my final sample are distributed among `r hh_df2 %>% distinct(UA) %>% nrow` UZAs. Figure \@ref(fig:uza-hist) shows histograms of UZA-level household VMT and number of household observations by UZA in the final sample used in following analysis. 

```{r uza-hist, fig.cap="Histograms of UZA-level weighted average VMT and Number of household observations by UZA"}
uza_dvmt <- hh_df2 %>% 
  group_by(UA) %>% 
  summarize(nhhs=n(),
            DVMT_wtavg=sum(DVMT * hhwgt, na.rm=T)/sum(hhwgt, na.rm=T),
            DVMT_sd=sd(DVMT, na.rm=T),
            DVMT_min=min(DVMT, na.rm=T),
            DVMT_median=median(DVMT, na.rm=T),
            DVMT_max=max(DVMT, na.rm=T),
            UZAPOP=first(UZAPOP),
            UZAEMPDEN=first(UZAEMPDEN)) %>% 
  arrange(desc(DVMT_wtavg))

p1 <- ggplot(uza_dvmt) + geom_histogram(aes(DVMT_wtavg)) +
  xlim(x=c(20, 65)) +
  labs(x="VMT (weighted average) ", y="# of UZAs")

#breaks = c(30, 50, 100, 1000, 3000)
p2 <- ggplot(uza_dvmt) + geom_histogram(aes(nhhs)) + 
  #scale_x_log10(breaks = breaks, labels = breaks) +
  xlim(x=c(30, 3000)) +
  labs(x="# Households in Sample", y="# of UZAs")

gridExtra::grid.arrange(p1, p2, nrow=1)
```

# Methods

There is a number of model structures applied in household VMT models. In Ewing and Cervero's review, they identify about a dozen model structures used in the literature, including linear regression, Tobit regression, hierarchical linear modeling, non-linear regression, logistic regression, probit regression, propensity score matching, copula-based switching model, simultaneous linear equations [@ewing_travel_2010-1] . In this paper, I apply two-step models for household VMT: 1.) a binomial logistic regression (logit) model of whether households making zero VMT; 2.) a log-linear regression of VMT for households with non-zero VMT. This model structure is the same as what Ewing et al [-@ewing_varying_2015] use for their household VMT models and has the best predictive performance [@wang2018].


<!-- These are the models included in this study: -->

<!-- 1. Linear Regression -->
<!--     a. OLS: $VMT_h = X_h^{SES} \beta + X_h^{BE} \gamma + \epsilon_h, \epsilon_h \sim N(0, \Sigma)$ -->
<!--     b. semi-log model: $\ln(VMT_h+1) = X_h^{SES} \beta + X_h^{BE} \gamma + \epsilon_h, \epsilon_h \sim N(0, \Sigma)$ -->
<!--     c. Box-Cox transformed: $(VMT_h^k-1)/k = X_h^{SES} \beta + X_h^{BE} \gamma + \epsilon_h, \epsilon_h \sim N(0, \Sigma)$ -->
<!--     d. hierarchical linear model: $VMT_h = X_h^{SES} \beta + X_h^{BE} \gamma_{UZA} + \epsilon_h, , \epsilon_h \sim N(0, \Sigma)$ and $\gamma_{UZA} \sim N_{UZA}(\mu, \sigma)$. -->
<!-- 2. Tobit: : $VMT_h = \begin{cases} VMT_h^* & \textrm{if} \; VMT_h^* >0 \\  0     & \textrm{if} \; VMT_h^* \leq 0 \end{cases}$ and $VMT_h^* = X_h^{SES} \beta + X_h^{BE} \gamma + \epsilon_h, \epsilon_h \sim N(0, \Sigma)$ -->
<!-- 3. 2-step models -->
<!--     a. 2-step fixed effect model: a binomial logistic regression model of whether households making zero VMT and a linear regression for households with non-zero VMT -->
<!--     b. 2-step hierarchical mixed model: similar to 3a, but incorporate UZA-level random effects with a mixed effect binomial logistic regression model and a hierarchical linear model. -->

## Base Fixed Effects Models

For each of the modeling steps, the base specification is fixed effect models with UZA specific intercepts, in which I assume that each UZA has a different but constant effect on the response variables ($\Pr(VMT_{hu}=0)$ and $VMT_{hu}$), but the effects of built environment factors on driving are the same across all UZAs.

Specifically, in the base fixed effects specification, the $\Pr(VMT_{iu}=0)$ logit model:

\begin{equation}
(\#eq:base-step1)
\begin{split}
\Pr(VMT_{iu}=0) = \frac{\exp(V_{iu})}{1 + \exp(V_{iu})}, \text{where} \\
V_{iu} = \alpha_{u} + \beta X_{iu}^{SES} + \gamma X_{iu}^{BE}
\end{split}
\end{equation}

and the $VMT_{iu}$ log-linear regression model:

\begin{equation}
(\#eq:base-step2)
log(VMT_{iu}) \sim N(a_{u} + b X_{iu}^{SES} + c X_{iu}^{BE}, \sigma) \text{for} VMT_{iu} > 0
\end{equation}

$VMT_{iu}$ is the vehicle miles traveled by household $i$ living in UZA $u$. $\alpha_u$, $\beta$, and $\gamma$ in the $\Pr(VMT_{iu}=0)$ logit model (Equation \@ref(eq:base-step1)) are model coefficients to be estimated for UZA specific fixed effects, social economic status variables ($X_{iu}^{SES}$), and the built environment variables ($X_{iu}^{BE}$), respectively; while $a_u$, $b$, and $c$ are their counterparts in the $VMT_{iu}$ log-linear regression model (Equation \@ref(eq:base-step2)). 

## Full Fixed Effect Models

In addition to the base fixed effect models with UZA specific intercepts, I estimate another pair of fixed effect models in which I allow the slopes for the built environment variables ($X_{iu}^{BE}$) to vary by UZA. Mathematically, in the full models, Equation \@ref(eq:base-step1) becomes

\begin{equation}
(\#eq:fixed-step1)
\begin{split}
\Pr(VMT_{iu}=0) = \frac{\exp(V_{iu})}{1 + \exp(V_{iu})}, \text{where} \\
V_{iu} = \alpha_{u} + \beta X_{iu}^{SES} + \gamma_u X_{iu}^{BE}
\end{split}
\end{equation}

and, similarly, Equation \@ref(eq:base-step2) turns into

\begin{equation}
(\#eq:fixed-step2)
\log(VMT_{iu}) \sim N(a_{u} + b X_{iu}^{SES} + c_u X_{iu}^{BE}, \sigma) \text{for } VMT_{iu} > 0
\end{equation}

In Equations \@ref(eq:fixed-step1) and \@ref(eq:fixed-step2), I estimate UZA specific coefficients for built environment variables $X_{iu}^{BE}$. That is, I have a coefficient for each built environment variable for each UZA, representing possible varying effects of built environment factors across UZA.

While the large sample size of my data allows me to estimate the full fixed effects models with hundreds of parameters, the specification segments the sample by UZA for the built environment variables and leaves a small number of observations usable to estimate the fixed effects for many of the UZAs (Figure \@ref(fig:uza-hist)). This leads to coefficient estimates with large standard errors and statistically insignificant results.

Another problem with the fixed effects models is that the error term is assumed to be independent from each other, which is likely violated as observations from the same group are likely sharing some unobserved factors contributing to their error term, and thus have more correlated errors than those from different groups. In the case of modeling household VMT using the NHTS data, households from the same Urbanized Areas (UZA) share the same regional factors, such as the weather, transportation infrastructure, terrain, etc, that can only be partially captured in the observed data. This likely leads to the violation of model assumptions for fixed effects models. 

## Mixed Effect Models

Mixed effects models address both limitations of fixed effect models by partially pooling observations from different groups and by including random coefficients that absorb the unobserved group characteristics shared by observations from a group [@gelman2006].

<!-- ## Mixed models -->

<!-- Also multilevel models or hierarchical linear models -->
<!-- 1. violation of model assumptions - iid, groups/uza sharing unobserved influences -->
<!-- 2. sample size varying from UZA to UZA. unlike segmented models, for which I will have to drop observations from groups with fewer observation -->
<!-- 3. Reasons for random effects (https://dynamicecology.wordpress.com/2015/11/04/is-it-a-fixed-or-random-effect/) -->
<!--    1. save degrees of freedom -->
<!--    2. First, maybe it is actually more interesting to estimate the variance across all possible sites -->
<!--    3. But another very practical reason is I might want to do variance partitioning (Such variance partition can be done by hand with a few simple calculations on outputs from mixed model packages (nlme, lme4) or by functions like varcomp in package ape) -->

Similar to the fixed effects models, I specify a pair of base and full mixed effects models that allow random effects for the intercepts and built environment factors, respectively. I assume the coefficients for household social-economics characteristics, $\beta$ and $b$, are fixed across UZAs, while the built environment measures have random effects that vary from UZA to UZA in addition to mean fixed effects. Comparing the fixed effect models and the mixed effect models allow me to test the hypothesis that there is regional variations in the effects of built environment on driving.

### Base mixed effects models

The base mixed effects models only incorporate random effects for the intercept, while all other independent variables have only fixed effects. Mathematically,

\begin{equation}
(\#eq:mixed0-step1)
\begin{split}
\Pr(VMT_{iu}=0) = \frac{\exp(V_{iu})}{1 + \exp(V_{iu})}, \text{where} \\
V_{iu} = \alpha_{iu} + \beta X_{iu}^{SES} + \gamma X_{iu}^{BE}, \\
\alpha_{iu} \sim N(\bar{\alpha}, \sigma_{\alpha})
\end{split}
\end{equation}

\begin{equation}
(\#eq:mixed0-step2)
\begin{split}
VMT_{iu} \sim N(a_{iu} + b X_{iu}^{SES} + c X_{iu}^{BE}, \sigma^2)
a_{iu} \sim N(\bar{a}_{iu}, \sigma_{a}^2)
\end{split}
\end{equation}

### Full mixed effects models:

In the full mixed effects models, in addition to the intercept, random effects are also included for built environment variables:

\begin{equation}
(\#eq:mixed1-step1)
\begin{split}
V_{iu} = \alpha_{iu} + \beta X_{iu}^{SES} + \gamma_{iu} X_{iu}^{BE}, \text{where} \\
\alpha_{iu} \sim N(\bar{\alpha}, \sigma_{\alpha}), \text{and} \\
\gamma_{iu} \sim N(\bar{\gamma}, \Sigma_{\gamma})
\end{split}
\end{equation}

\begin{equation}
(\#eq:mixed1-step2)
\begin{split}
VMT_{iu} \sim N(a_{iu} + b X_{iu}^{SES} + c X_{iu}^{BE}, \sigma), \text{where} \\
a_{iu} \sim N(\bar{a}, \sigma_{a}), \text{and} \\
c_{iu} \sim N(\bar{c}, \Sigma_{c})
\end{split}
\end{equation}

## Model Specification

The `glm` function in the base R [@r_2017] and the `glmer` function from the `lme4` package for R [@bates_fitting_2015] is used to estimate the fixed effect models and the mixed effect models, respectively.

In the model selection process, I first control for social-economics status of the household. Most of the "usual suspects" that have been reported in the literature to affect travel behavior are included: household size, life cycle, income, number of workers, vehicles in the household. I also included household's poverty status that are derived from income, household size, and Department of Health and Human Services (HHS)'s poverty guidelines.

I then use a forward model selection process to select at least one variables from each of the 5D categories, while avoiding including new variables that are highly correlated with variables already in the model. I keep the same specification throughout all models to maintain comparability of results. 

<!-- Next set of independent variables are the urban area level variables, including population and employment density, freeway lane miles per 1000 population, and transit revenue miles per 1000 population. Except for mixed models, I include an intercept for each UZA. -->

<!-- The final set of independent variables are the block group level built environment measures from the EPA Smart Location database. The measures are largely organized around the 5D's: density, diversity, design, distance to transit, and destination accessibility. Within each D, there are usually multiple measures. For example, for density, there are  -->


```{r fixed-models, cache=TRUE, include=FALSE}
source("code/fixed_effects.R")
```


<!-- ## Computing Elasticity -->

<!-- Since predicting VMT involving two steps in this setup, I compute the average elasticity for built environment measures in each model by averaging the estimated disaggregate elasticity across all households in my sample, using the same approach as Rodriguez and Joo [-@rodriguez_relationship_2004-1].  -->

# Results

## Fixed Effects Models

Table \@ref(tab:fixed-coeffs) shows the estimation results of the base and full fixed effects models for the ZeroDVMT logit step and DVMT log-linear step. All coefficients in these models have expected signs and, as expected, the built environment measures have significant coefficients that are small in magnitude in comparison with the social economic status variables.

```{r fixed-coeffs, results="asis"}
texreg(list(glm1, glm1i, glm2, glm2i), 
       custom.model.names=c("Base logit", "Full logit", 
                            "Base log-linear", "Full log-linear"), 
       digits = 4,
       single.row = TRUE,
       custom.coef.names = c("Intercept", "Income \\\\ \\hspace{1cm}\\$10-30k",
                             "\\hspace{1cm}\\$30-50k", "\\hspace{1cm}\\$50-70k",
                             "\\hspace{1cm}\\$70-100k", "\\hspace{1cm}>\\$100k",
                             rep(NA, 10),
                             "\\hspace{1cm}Empty Nester",
                             "\\hspace{1cm}Parents w/ children", "Life Cycle\\\\ \\hspace{1cm}Single"),
       reorder.coef = c(1:11, 19, 18, 17, 12:16),
       omit.coef = "^UA",
       caption.above = TRUE,
       caption = "Estimation Results of Fixed Effects Models",
       label = "tab:fixed-coeffs",
       dcolumn = TRUE,
       table = TRUE, sideways = TRUE,
       use.packages = FALSE,
       custom.note = "%stars. Standard errors in parentheses. UZA specific intercepts and coefficients are not shown for space reasons.")
```

UZA specific intercepts and coefficients in the full fixed effects models are not shown in Table \@ref(tab:fixed-coeffs) for space reasons. Most of these UZA specific coefficients are not significant, due to the small number of observations for many UZAs. 

Figure \@ref(fig:fixed-coeffs-viz1) shows the point estimates and confidence intervals for each UZA specific coefficient in the full fixed effects logit model. The solid line represents the point estimate, while the horizontal grey bar shows the confidential interval. It is apparent in Figure \@ref(fig:fixed-coeffs-viz1) that the point estimates cover a wide range and these estimates for most UZAs are not statistically significant (as showing by their confidence interval intersecting value 0).

```{r prep-viz, include=F}
source("code/visualize_ci.R")
var_list <- c("Intercept", "D1B", "D2A_WRKEMP", "D3a", "D4b050", "D5ar1k")
# escape _ for caption
subcap_list <- c("Intercept", "D1B", "D2A\\_WRKEMP", "D3a", "D4b050", "D5ar1k")
```

```{r fixed-coeffs-viz1, fig.cap="Point estimates and confidence intervals from the full ZeroDVMT logit model for each built environment variable by UZA", fig.subcap=subcap_list, out.width='.4\\linewidth', fig.asp=1, fig.ncol = 2, fig.align="center", results='hide'}
#plot_fixed_effects1 <- map(var_list, ~visualize_ci(glm1i, var_name=.x))
#plot_fixed_effects1 <- lapply(var_list, function(x) visualize_ci(glm1i, var_name=x))
map(var_list, ~visualize_ci(glm1i, var_name=.x))
#gridExtra::grid.arrange(grobs=plot_fixed_effects1, ncol=1)
```

Figure \@ref(fig:fixed-coeffs-viz2) shows the point estimates and confidence intervals for each UZA specific coefficient in the full fixed effect log-linear model. Similar to the results for the logit model, the point estimates in the full fixed effects log-linear model also cover a wide range, with the estimates for most UZAs are statistically insignificant.

```{r fixed-coeffs-viz2, fig.cap="Point estimates and confidence intervals from the full DVMT log-linear model for each built environment variable by UZA", fig.subcap=subcap_list, out.width='.4\\linewidth', fig.asp=1, fig.ncol = 2, fig.align="center", results='hide'}
map(var_list, ~visualize_ci(glm2i, var_name=.x))
#gridExtra::grid.arrange(grobs=plot_fixed_effects2, ncol=2)
```

```{r}
lrtest1 <- lrtest(glm1, glm1i)
lrtest1$p <- round(lrtest1$`Pr(>Chisq)`[[2]], digits=3)
lrtest2 <- lrtest(glm2, glm2i)
lrtest2$p <- round(lrtest2$`Pr(>Chisq)`[[2]], digits=3)
```

I then compare the full models against the base models with log-likelihood ratio tests as they are nested specifications [@ben-akiva_discrete_1987]. For the ZeroDVMT logit model, a log-likelihood ratio test indicates that the full model performs better than the base model (p=`r lrtest1$p`, $\chi^2$=`r lrtest1$Chisq[2]` with `r lrtest1$Df[2]` degrees of freedom); likewise, for the DVMT log-linear model, the full model performs better than the base model (p=`r lrtest2$p`, $\chi^2$=`r lrtest2$Chisq[2]` with `r lrtest2$Df[2]` degrees of freedom). These tests imply that there are indeed regional variations in the effects of built environment. 

```{r mixed-models, cache=TRUE, include=FALSE}
source("code/mixed_effects.R")
```


## Mixed Effects Models

For the mixed effect models, the fixed effects coefficients and the variance-covariance matrices for the random effects coefficients are reported in Table \@ref(tab:mixed-coeffs). For the base models, the model coefficients in the mixed effects model is almost identical with those in the fixed effects models. 

However, there is substantial difference in the results for the full models. Note that, except for the coefficient for D2A\_WRKEMP and D4b050 in the Zero VMT logit model (even for them, the significance drops), all other built environment measures no longer have significant fixed effects coefficients. That is, after accounting for slopes that vary from UZA to UZA, there is no average effects to speak of for most built environment variables. This is another indication of substantial regional variation in the effects of built environment.

<!-- are negible, but the mean coefficients in the mixed models are similar to those in the fixed effect models. The mean coefficients for D1B in the mixed effect zero VMT model is `0.05` compared with `0.01` in the fixed effect zero VMT model. Some of coefficients have varying significance between the fixed effect model and mixed effect models. -->

```{r mixed-coeffs, results="asis"}
texreg(list(glmx1, glmx1i, glmx2, glmx2i), 
       digits = 4, 
       #single.row = TRUE,
       #table=TRUE, sideways = TRUE,
       custom.model.names=c("Base logit", "Full logit", 
                            "Base log-linear", "Full log-linear"), 
       custom.coef.names = c("Intercept", "Income \\\\ \\hspace{1cm}\\$10-30k",
                             "\\hspace{1cm}\\$30-50k", "\\hspace{1cm}\\$50-70k",
                             "\\hspace{1cm}\\$70-100k", "\\hspace{1cm}>\\$100k",
                             rep(NA, 10),
                             "\\hspace{1cm}Empty Nester",
                             "\\hspace{1cm}Parents w/ children", "Life Cycle\\\\ \\hspace{1cm}Single"),
       reorder.coef = c(1:11, 19, 18, 17, 12:16),
       custom.gof.names = c(rep(NA, 4), "Num. groups: UZA", "Var: Intercept",
                            "Var: D1B", "Var: D2A\\_WRKEMP", "Var: D3a", 
                            "Var: D4b050", "Var: D5ar1k", "Cov: Intercept D1B", 
                            "Cov: Intercept D2A\\_W..", "Cov: Intercept D3a", 
                            "Cov: Intercept D4b050", "Cov: Intercept D5ar1k", 
                            "Cov: D1B D2A\\_W..", "Cov: D1B D3a", "Cov: D1B D4b050", 
                            "Cov: D1B D5ar1k", "Cov: D2A\\_W.. D3a", 
                            "Cov: D2A\\_W.. D4b050", "Cov: D2A\\_W.. D5ar1k", 
                            "Cov: D3a D4b050", "Cov: D3a D5ar1k", "Cov: D4b050 D5ar1k", 
                            "Var: Residual"),
       omit.coef = "^UA",
       caption.above = TRUE,
       caption = "Estimation Results of Mixed Effects Models",
       label = "tab:mixed-coeffs",
       longtable = TRUE,
       dcolumn = TRUE,
       use.packages = FALSE,
       custom.note = "%stars.")

```


<!-- ## Elasticity -->

<!-- Given the similar model coefficients between fixed effect models and mixed effect models, the elasticity are similar too and in line with what has been reported in the literature [@ewing_travel_2010-1]. -->

```{r model-elasticities, tab.cap="Elasticities for Fixed Effect Models and Mixed Effect Models", eval=FALSE}
#test_df <- tibble(data=list(hh_df), 
#                  model_num=m1cm$model_num)

#model_df <- bind_rows(glm_0dvmt, lm_dvmt)
#model_df <- lm_dvmt
#model_df$bias.adj <- 1.0

all_models <- bind_rows(m2cm %>% dplyr::select(-model_desc))
test_df <- tibble(data=list(hh_df), 
                  model_num=all_models$model_num %>% unique)

all_models$bias.adj <- 1.0
x_args <- c(1, 1.01)
eyx_results <- NULL
for (v1 in c("D1B", "D2A_EPHHM", "D3a", "D3bpo4", "D5ar")) {
 ybars <- ybar_by_dx(test_df, x_col=v1, all_models,
               y_col="DVMT",
               x_args=x_args, x_func = `*`,
               segment_col=NULL,
               update_dependencies=FALSE,
               update_func=NULL
               )

  #Eyx(ybars)
 eyx_v1 <- aggregate_Eyx(ybars)
 eyx_v1$Variable <- v1
 eyx_results <- `if`(is.null(eyx_results), eyx_v1, bind_rows(eyx_results, eyx_v1))
}

eyx_results %>% dplyr::select(model_num, Variable, E_bar) %>% 
  spread(model_num, E_bar) %>% 
  knitr::kable()

# cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
# 
# ggplot(ybars, aes(x=dx, y=y_bar, group=model_num, color=model_num)) + 
#   geom_line(size=2) +
#   scale_colour_manual(values=cbPalette)
# 
# y_bar1 <- ybars %>% filter(dx==1.0) %>% 
#   dplyr::select(model_num, y_bar1=y_bar)
# 
# ybars1 <- ybars %>% left_join(y_bar1, by="model_num") %>% 
#   mutate(index=y_bar/y_bar1)
# 
# ggplot(ybars1, aes(x=dx, y=index, group=model_num, color=model_num)) + 
#   geom_line(size=2) +
#   scale_colour_manual(values=cbPalette)
```


```{r, eval=FALSE}

test_df <- tibble(data=list(hh_df), 
                  model_num=m2cm$model_num %>% unique)

#model_df <- bind_rows(glm_0dvmt, lm_dvmt)
#model_df <- lm_dvmt
#model_df$bias.adj <- 1.0

m2cm$bias.adj <- 1.0
x_args <- c(1, 1.05) #seq(0.4, 2, by=.2)
ybars <- ybar_by_dx(test_df, x_col="D1B", m2cm,
               y_col="DVMT",
               x_args=x_args, x_func = `*`,
               segment_col=NULL,
               update_dependencies=FALSE,
               update_func=NULL
               )


Eyx(ybars)

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

ggplot(ybars, aes(x=dx, y=y_bar, group=model_num, color=model_num)) + 
  geom_line(size=2) +
  scale_colour_manual(values=cbPalette)

y_bar1 <- ybars %>% filter(dx==1.0) %>% 
  dplyr::select(model_num, y_bar1=y_bar)

ybars1 <- ybars %>% left_join(y_bar1, by="model_num") %>% 
  mutate(index=y_bar/y_bar1)

ggplot(ybars1, aes(x=dx, y=index, group=model_num, color=model_num)) + 
  geom_line(size=2) +
  scale_colour_manual(values=cbPalette)
```

## Random Effects and Regional Variation of Coefficients

```{r}
lrtest1mx <- lrtest(glmx1, glmx1i)
lrtest1mx$p <- round(lrtest1mx$`Pr(>Chisq)`[[2]], digits=3)
lrtest2mx <- lrtest(glmx2, glmx2i)
lrtest2mx$p <- round(lrtest2mx$`Pr(>Chisq)`[[2]], digits=3)
```

I again use log-likelihood ratio tests between the base and full mixed effects models to test the hypothesis that there is no regional variations in model coefficients  (random slopes) for the built environment measures, as they can be seen as pairs of nested models with the fixed effect models being a restricted version of the mixed effect models [@ben-akiva_discrete_1987]. For both the zero VMT logit and DVMT log-linear regression model, the full mixed effect models perform significantly better than the base mixed effect models (p<0.0000001 for both tests), which leads me to reject the hypothesis of no regional variations of model coefficients for built environment measures.

```{r lrtest1, tab.cap="TABLE 3. Results of log-Likelihood Ratio Tests between Fixed Effect and Mixed Effect Zero VMT Models", eval=FALSE}
lrtx <- m2cm %>% 
    dplyr::select(model_num, `Model Name`=step, model) %>% 
    mutate(`Model Name`=ifelse(`Model Name`==1, "Logistic Regression of Zero VMT", "Linear Regression of Household VMT")) %>%
    tidyr::spread(model_num, model) %>%
    mutate(lrt=map2(`Fixed Effect`, `Mixed Effect`, ~lrtest(.y, .x)),
           p=map_dbl(lrt, ~.x$`Pr(>Chisq)`[[2]]))
    
lrtx$lrt[[1]] %>% knitr::kable()
```

```{r lrtest2, tab.cap="TABLE 4. Results of log-Likelihood Ratio Tests between Fixed Effect and Mixed Effect Household VMT Models", eval=FALSE}
lrtx$lrt[[2]] %>% knitr::kable()
```

Mixed effect models also provide UZA-specific coefficients for those built environment variables that I assume to have random coefficients (slopes). As can be seen in Figure \@ref(fig:mixed-coeffs-viz1) and \@ref(fig:mixed-coeffs-viz2), the random model coefficients for UZA cover a range. They can be compared with the UZA-specific coefficients from the full fixed effects models in Figure \@ref(fig:fixed-coeffs-viz1) and \@ref(fig:fixed-coeffs-viz2), respectively. Compared with the results from the full fixed effects models, those from the mixed effects have a narrower range, attesting to the advantage of mixed effects models in partially pooling observations. The random effects are also asymmetrical. For example, for the D1B coefficient in the VMT log-linear model (Figure \@ref(fig:mixed-coeffs-viz2)), most of the UZAs have expected negative value, while a small percentage of UZAs have positive value.

<!-- [@ewing_traffic_2011] estimates a random effects model among residents at different project site level. Their model only consider random intercepts.  -->

<!-- modelx -->
<!-- 1. linear regression -->
<!--    - non-transformed -->
<!--    - transformed -->
<!-- - 2 step model (logit + linear regression) -->
<!-- - tobit -->

```{r prep-viz-mixed, include=F}
source("code/visualize_ci.R")
var_list <- c("Intercept", "D1B", "D2A_WRKEMP", "D3a", "D4b050", "D5ar1k")
# escape _ for caption
subcap_list <- c("Intercept", "D1B", "D2A\\_WRKEMP", "D3a", "D4b050", "D5ar1k")
```

```{r mixed-coeffs-viz1, fig.cap="Random coefficients from the full ZeroDVMT logit model for each built environment variable by UZA", fig.subcap=subcap_list, out.width='.4\\linewidth', fig.asp=1, fig.ncol = 2, fig.align="center", results='hide'}
map(var_list, ~visualize_randeff(glmx1i, var_name=.x))
```

```{r mixed-coeffs-viz2, fig.cap="Random coefficients from the full DVMT log-linear model for each built environment variable by UZA", fig.subcap=subcap_list, out.width='.4\\linewidth', fig.asp=1, fig.ncol = 2, fig.align="center", results='hide'}
map(var_list, ~visualize_randeff(glmx2i, var_name=.x))
```

```{r random-effects, fig.cap="Density Plots of UZA-specific Model Coefficients by Variable and Model", eval=FALSE}
ua_info <- ua_df %>%
  dplyr::select(UACE, UA_NAME) %>%
  left_join(hh_df %>% 
              group_by(UACE) %>% 
              summarize(nhhs=n()))

randeff_0v <- ranef(m2cm$model[[3]])$UACE
randeff_0v$model_desc <- "Mixed: Pr(VMT=0)"
randeff_0v <- randeff_0v %>% rownames_to_column(var = "UACE") %>%
  left_join(ua_info)

randeff_1v <- ranef(m2cm$model[[4]])$UACE
randeff_1v$model_desc <- "Mixed: VMT|VMT>0"
randeff_1v <- randeff_1v %>% rownames_to_column(var = "UACE") %>%
  left_join(ua_info)

randeff <- bind_rows(randeff_0v, randeff_1v) %>% 
  gather(Variable, Coefficients, D1B:`I(D5ar/1000)`)

gridExtra::grid.arrange(
ggplot(randeff %>% filter(Variable =="D1B")) + 
  geom_density(aes(Coefficients, group=model_desc, color=model_desc)) +
  labs(x="D1B coefficient") +
  theme(legend.position = c(0.8, 0.8)),
  #facet_wrap(~Variable)

ggplot(randeff %>% filter(Variable =="D2A_EPHHM")) + 
  geom_density(aes(Coefficients, group=model_desc, color=model_desc)) +
  labs(x="D2A_EPHHM coefficient") +
  theme(legend.position='none'),

ggplot(randeff %>% filter(Variable =="D3a")) + 
  geom_density(aes(Coefficients, group=model_desc, color=model_desc)) +
  labs(x="D3a coefficient") +
  theme(legend.position='none'),

ggplot(randeff %>% filter(Variable =="D3bpo4")) + 
  geom_density(aes(Coefficients, group=model_desc, color=model_desc)) +
  labs(x="D3bpo4 coefficient") +
  theme(legend.position='none'),

ggplot(randeff %>% filter(Variable =="I(D5ar/1000)")) + 
  geom_density(aes(Coefficients, group=model_desc, color=model_desc)) +
  labs(x="D5ar (in 1,000s) coefficient") +
  theme(legend.position='none'),
nrow=2
)
```

<!-- - Potential moderating effects of UZA (5D/density -->
<!-- - Variation in elasticity (random effects) across UZA:  -->
<!--    - Not sufficiently explored in previous research due to data limitation -->
<!-- - beyond the fixed effect, UZA-specific intercepts and random intercepts     -->

<!-- I can further compute the UZA-specific built environment elasticity of driving based on the random coefficients. Figure @\ref(fig:random-elasticity) shows the distribution of elasticity in boxplot. It's clear that there is substantial variations in built environment elasticity across UZAs, in particular, the D3a road network density variable. -->

```{r random-elasticities, fig.cap="Boxplot of built environment elasticities across UZAs", eval=FALSE}
aggregate_Eyx_UACE <- function(ybars) {
  ## second approach
  ## first aggregated dy/y before divided by (dx/x)
  stopifnot(any(ybars$dx == 1.0))
  y0 <- ybars %>% 
    filter(dx == 1.0) %>% 
    dplyr::select(UACE, y0=yhat_bar)

  ybars %>% 
    filter(dx != 1.0) %>% 
    dplyr::select(UACE, dx, yhat_bar) %>% 
    left_join(y0, by="UACE") %>% 
    mutate(pdy=(yhat_bar - y0)/y0, 
           pdx=dx - 1, E_bar=pdy/pdx)
}

test_df2 <- tibble(data=list(hh_df), 
                  model_num="Mixed Effect")

x_args <- c(1, 1.01)
uza_eyx_results <- NULL
for (v1 in c("D1B", "D2A_EPHHM", "D3a", "D3bpo4", "D5ar")) {
 ybars <- ybar_by_dx(test_df2, x_col=v1, m2cm,
               y_col="DVMT",
               x_args=x_args, x_func = `*`,
               segment_col=NULL,
               update_dependencies=FALSE,
               update_func=NULL
               )

 ybars_UACE <- test_df2 %>%
  left_join(ybars) %>% 
  #add UACE and HOUSEID (for verification)
  mutate(UACE=map(data, "UACE"), HOUSEID=map(data, "HOUSEID")) %>% 
  dplyr::select(dx, y_hat, UACE, HOUSEID) %>% 
  unnest(y_hat, UACE, HOUSEID) %>% 
  group_by(dx, UACE) %>% 
  nest() %>% 
  mutate(yhat=map(data, "y_hat"),
         yhat_bar=map_dbl(yhat, mean, na.rm=T))

  #Eyx(ybars)
 eyx_v1 <- aggregate_Eyx_UACE(ybars_UACE)
 eyx_v1$Variable <- v1
 uza_eyx_results <- `if`(is.null(uza_eyx_results), eyx_v1, bind_rows(uza_eyx_results, eyx_v1))
}

ggplot(uza_eyx_results) + geom_boxplot(aes(x=Variable, y=E_bar)) +
  labs(y="elasticity")
# ybars_UACE <- test_df2 %>%
#   left_join(ybars) %>% 
#   mutate(UACE=map(data, "UACE"), HOUSEID=map(data, "HOUSEID")) %>% 
#   dplyr::select(dx, y_hat, UACE, HOUSEID) %>% 
#   unnest(y_hat, UACE, HOUSEID) %>% 
#   group_by(dx, UACE) %>% 
#   nest() %>% 
#   mutate(yhat=map(data, "y_hat"),
#          yhat_bar=map_dbl(yhat, mean, na.rm=T))
# 
# aggregate_Eyx_UACE(z_df) %>% 
#   arrange(E_bar)

```

# Conclusion and Discussion

In this paper, I start to explore the regional variation in the effects of built environment on driving. With a nationwide dataset and high resolution built environment measures, I evaluate the regional variation in the effect on VMT across the UZAs in the U.S with fixed and mixed effects models. My results indicate there are substantial regional variations in the random coefficients for built environment measures. The long-lasting fixation in the literature on estimating fixed effects of built environment variables is problematic. Particularly, there are no fixed effects for most built environment variables that apply to all UZAs after considering random effects. However, disregarding the effects of built environment on driving because of low average elasticity miss the point too - for certain regions, built environment can and do have large effects on driving.

Previous research largely rely on data from a single region or a few regions and thus is not able to sufficiently explore such regional variations. Several research efforts have been dedicated to synthesize numerous previous research and come up with a single point estimate of the effect My research indicates that, while a point estimate may be more straightforward, the effects of built environment may vary substantial from region to region. A few recent papers [@salon_heterogeneity_2015 and @ralph_millennials_2016-1] examine the heterogeneity of elasticity across neighborhood types and population groups, but they still assume households living in the same neighborhood types have the same elasticity across different regions. My finding has implications for applications of point estimates of elasticity in projecting effects various policies involving built environment. While point estimates may be much easier to apply, it fails to present the uncertainty in the possible effects. It may also discourage actions since the average effects are small. Indeed, Stevens argues based on the average elasticity that densification policies have minimal effects on driving [-@stevens_does_2017].

<!-- There have been many research on this topic. Most of them use data from a single region. A few synthesis observe the variation in the elasticity, but there is no explanation as of what give rise to such variations. -->

<!-- I take advantage of a unique dataset with 1.) large sample size; 2.) wide coverage of the U.S. 3.) comprehensive dataset with rich and high resolution built environment measures. -->

<!-- my research finds that there are substantial variations in elasticity due to different model structures. Besides the hierarchical mixed model indicates that the  -->

<!-- - Implications: uncertainties vs false certainty in predictions  -->

<!-- Previous research uses data from a single region or a few regions, which makes it harder to  -->

<!-- (neighborhood type?) The literature generally reports 10%-40% of the elasticity due to self-selection. -->

I would like acknowledge a number of limitations and future work of this research. Although I went through a variable selection process and my model specification include all the "usual suspects" in a model for household VMT, my model specifications are likely not the best possible. For example, I didn't consider variables at different geographical resolution, such as census tract- or UZA-level variables, as being considered and tested in other research [@gehrke2020]. It is also likely that the best model specification varies from model to model, but for my purpose to investigate regional variation, I keep the same model specification across different models. I didn't consider the potential mixed effects of social-economic status variables or their interactions with built environment variables at the region level. I also didn't address the potential residential self-selection bias in my models. There has been extensive research documenting the prevalence and magnitude of such bias [@cao_examining_2009]. There is research suggesting including SES variables in model specifications helps control potential self-selection bias [@naess_tempest_2014]. Finally, the 2017 NHTS dataset and a new version of the Smart Location Database have been released by FHWA and EPA, respectively, and it is now possible to update this research with these latest datasets and, furthermore, compare the results across these two cross sectional datasets. However, I haven't been able to get access to the confidential residence information of survey participants in 2017 NHTS and will have to update this work after I do.

This paper follows the practice of reproducible research: it is written using `rmarkdown`/`bookdown` formatted into a TRB article using the `rticle` R package and the TRB Latex template (https://github.com/chiehrosswang/TRB_LaTeX_tex). All the results and figures in the paper are rendered dynamically from R scripts made publicly available on the author's github repository (https://github.com/cities/nhts-mxlm). However, because I used the confidential NHTS data source, I cannot make the complete dataset publicly available and one cannot fully replicate my work.

# Acknowledgements

The author acknowledges partial financial support from the National Institute for Transportation and Communities (NITC) under grant number  NITC-1433 and from Oregon DOT under grant SPR-788.

<!-- # what is the reasonable choice for grouping here? UZA? -->
<!-- ```{r model-uza} -->
<!-- # UZA-level model -->
<!-- #' subject='UZA' -->

<!-- #d2 <-lcmm(DVMT~HhSize+D1A, random=~HhSize, subject='UZA', mixture=~D1A,ng=2,idiag=TRUE,data=hh_df,link="linear") -->
<!-- #summary(d2) -->
<!-- #postprob(d2)  -->

<!-- # d2 <-lcmm(DVMT~HhSize+D1A, random=~HhSize, subject='UZA', mixture=~D1A,ng=2,idiag=TRUE,data=hh.df,link="linear") -->
<!-- # summary(d2) -->
<!-- # postprob(d2)  -->

<!-- ``` -->

# References
